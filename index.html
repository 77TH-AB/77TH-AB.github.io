<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>77th Assault Brigade - Helldivers 2 Community</title>
        <link rel="icon" href="https://77th-ab.github.io/data/logo.png">
        <style>
            /* Vacant member link styles */
            .vacant-link {
                color: #ccc !important;
                font-style: italic;
                text-decoration: none;
                cursor: pointer;
                transition: color 0.2s;
            }
            .vacant-link:hover {
                color: #dbab10 !important;
                text-decoration: underline;
            }
            /* Home page vertical spacing */
            #page-home .hero-img {
                margin-bottom: 3rem;
            }
            #page-home .about-section {
                margin-bottom: 3rem;
            }
            #division-expanders {
                margin-top: 1.5rem;
            }
            .hero-img {
                width: -webkit-fill-available;
                max-width: -webkit-fill-available;
                height: 320px;
                object-fit: cover;
                display: block;
                margin-bottom: 0;
                box-shadow: 0 4px 32px #000a;
            }
            .page-container, .about-section, .division-expander, .intro, section, #war-report, #active-planets, #division-expanders {
                max-width: 900px;
                margin-left: auto;
                margin-right: auto;
                box-sizing: border-box;
            }
            .about-section {
                background: #222;
                border-radius: 14px;
                box-shadow: 0 2px 18px #dbab1033;
                padding: 2rem 2rem 1.5rem 2rem;
                color: #dbab10;
                font-size: 1.15rem;
            }
            .division-expander {
                background: #18181a;
                border-radius: 10px;
                box-shadow: 0 2px 12px #dbab1022;
                padding: 1.2rem 1.5rem;
                color: #fff;
                font-size: 1.08rem;
                cursor: pointer;
                border: 2px solid #dbab10;
                transition: box-shadow 0.2s, border-color 0.2s;
                margin-top: 1rem;
            }
            .division-expander:hover {
                box-shadow: 0 8px 32px #dbab1099;
                border-color: #fff;
            }
            .division-expander .expander-title {
                display: inline-flex;
                font-weight: bold;
                color: #dbab10;
                font-size: 1.15rem;
                margin-bottom: 0.5rem;
            }
            .expander-content {
                display: none;
                margin-top: 0.7rem;
                color: #dbab10;
                font-size: 1.05rem;
            }
            .division-expander.active .expander-content {
                display: block;
            }
            .menu-modal-btn {
                background: #dbab10;
                color: #18181a;
                border: none;
                border-radius: 8px;
                font-size: 1.3rem;
                font-weight: 900;
                padding: 0.7rem 1.3rem;
                cursor: pointer;
                box-shadow: 0 2px 12px #dbab1044;
                transition: background 0.2s, color 0.2s;
            }
            .menu-modal-btn:hover {
                background: #dbab10a8;
                color: #18181a;
            }
            .menu-modal-bg {
                display: none;
                position: fixed;
                top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.85);
                z-index: 2000;
                opacity: 0;
                transition: opacity 0.3s;
            }
            .menu-modal-bg[style*="display: block"] {
                opacity: 1;
            }
            .menu-modal {
                position: fixed;
                top: 50%; left: 50%;
                transform: translate(-50%, -50%) scale(0.95);
                background: #18181a;
                border-radius: 18px;
                box-shadow: 0 8px 48px #dbab1099;
                padding: 2rem 2.2rem 1.5rem 2.2rem;
                min-width: 320px;
                max-width: 95vw;
                z-index: 2100;
                border: 3px solid #dbab10;
                animation: modalIn 0.3s;
                color: #fff;
                text-align: center;
            }
            .menu-modal .menu-modal-close {
                position: absolute;
                top: 12px;
                right: 18px;
                font-size: 1.7rem;
                color: #dbab10;
                background: none;
                border: none;
                cursor: pointer;
                transition: color 0.2s;
            }
            .menu-modal .menu-modal-close:hover {
                color: #fff;
            }
            /* Company grid for modal */
            .company-list {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 1.2rem;
                margin-top: 1.2rem;
            }
            @media (max-width: 700px) {
                .company-list {
                    grid-template-columns: 1fr;
                }
            }
            body {
                margin: 0;
                font-family: 'Orbitron', 'Segoe UI', 'Roboto', Arial, sans-serif;
                background: #111112;
                color: #fff;
            }

            header {
                display: flex;
                align-items: center;
                justify-content: center;
                flex-direction: column;
                padding: 1rem 1rem 1rem 1rem;
                background: #18181a;
                border-bottom: 4px solid #dbab10;
                box-shadow: 0 2px 12px #000a;
            }

            header img {
                width: 120px;
                height: auto;
                margin-bottom: 1rem;
                filter: drop-shadow(0 0 12px #dbab10);
            }

            h1 {
                font-size: 2.7rem;
                margin: 0.5rem 0 0.2rem 0;
                letter-spacing: 2px;
                text-shadow: 0 2px 12px #dbab1044;
                color: #dbab10;
                font-weight: 900;
            }

            .subtitle {
                font-size: 1.2rem;
                color: #fff;
                margin-bottom: 1rem;
                text-shadow: 0 1px 8px #dbab1044;
                font-weight: 700;
            }

            main {
                width: -webkit-fill-available;
                max-width: -webkit-fill-available;
                margin: 0;
                padding: 0;
                background: #18181a;
                border-radius: 0;
                box-shadow: none;
                border: none;
            }

            .intro, section {
                /* Use .page-container for uniform width */
                padding-top: 1rem;
                padding-bottom: 1rem;
            }
            @media (max-width: 700px) {
                .page-container, .about-section, .division-expander, .intro, section, #war-report, #active-planets, #division-expanders {
                    max-width: 98vw;
                    padding-left: 0.5rem;
                    padding-right: 0.5rem;
                }
            }

            .roster {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 2rem;
                justify-content: center;
            }
            @media (max-width: 700px) {
                .roster {
                    grid-template-columns: 1fr;
                    gap: 1.2rem;
                }
            }
            .division-card {
                background: #222;
                border-radius: 12px;
                box-shadow: 0 2px 18px #dbab1033;
                padding: 1.2rem 0.8rem;
                min-width: 280px;
                /* max-width: 340px; */
                flex: 1 1 280px;
                cursor: pointer;
                transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
                border: 2px solid #dbab10;
                position: relative;
            }
            .division-card:hover {
                transform: translateY(-6px) scale(1.03);
                box-shadow: 0 8px 32px #dbab1099;
                border-color: #fff;
            }
            .division-title {
                color: #dbab10;
                font-size: 1.3rem;
                margin-top: 0;
                margin-bottom: 0.5rem;
                font-weight: bold;
            }
            .division-commander {
                font-size: 1rem;
                margin-bottom: 0.7rem;
                color: #fff;
            }
            .division-deployment {
                font-size: 0.98rem;
                margin-bottom: 0.7rem;
                color: #dbab10;
            }
            /* Modal overlay and animation */
            .modal-bg {
                display: none;
                position: fixed;
                top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.85);
                z-index: 1000;
                opacity: 0;
                transition: opacity 0.3s;
            }
            .modal-bg[style*="display: block"] {
                opacity: 1;
            }
            .modal {
                position: fixed;
                top: 50%; left: 50%;
                transform: translate(-50%, -50%) scale(0.95);
                background: #18181a;
                border-radius: 18px;
                box-shadow: 0 8px 48px #dbab1099;
                padding: 2rem 2.2rem 1.5rem 2.2rem;
                    min-width: 320px;
                max-width: 95vw;
                max-height: 90vh;
                overflow-y: auto;
                z-index: 1100;
                border: 3px solid #dbab10;
                animation: modalIn 0.3s;
                color: #fff;
            }
            @media (max-width: 700px) {
                .modal {
                    min-width: 98vw;
                    max-width: 98vw;
                    padding: 1rem;
                    font-size: 1rem;
                }
                .company-list {
                    grid-template-columns: 1fr;
                    gap: 0.7rem;
                }
            }
            @keyframes modalIn {
                from { opacity: 0; transform: translate(-50%, -60%) scale(0.8); }
                to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            }
            .modal-close {
                position: absolute;
                top: 12px;
                right: 18px;
                font-size: 1.7rem;
                color: #dbab10;
                background: none;
                border: none;
                cursor: pointer;
                transition: color 0.2s;
            }
            .modal-close:hover {
                color: #fff;
            }
            .modal h2 {
                color: #dbab10;
                margin-top: 0;
                margin-bottom: 0.5rem;
                font-weight: 900;
            }
            .modal .commander {
                color: #fff;
                font-size: 1.05rem;
            }
            .modal .deployment {
                color: #dbab10;
                font-size: 1rem;
            }
            .modal .company {
                background: #222;
                border-radius: 8px;
                border: 2px solid #dbab10;
                margin-bottom: 1.2rem;
                padding: 1rem 1.2rem;
                box-shadow: 0 2px 12px #dbab1022;
            }
            .modal .company h3 {
                margin-top: 0;
                margin-bottom: 0.5rem;
                font-size: 1.15rem;
                color: #dbab10;
                font-weight: 700;
            }
            .modal .company .commander {
                margin-bottom: 0.5rem;
                color: #fff;
                font-size: 0.98rem;
            }
            .modal .squad {
                margin-bottom: 0.7rem;
                padding-left: 0.5rem;
            }
            .modal .squad-name {
                font-weight: bold;
                color: #dbab10;
                font-size: 0.98rem;
            }
            .modal .members {
                list-style: none;
                padding-left: 0;
                margin: 0.2rem 0 0.5rem 0;
            }
            .modal .members li {
                font-size: 0.95rem;
                color: #fff;
                margin-bottom: 0.1rem;
            }
            .header-content {
                display: flex;
                align-items: center;
                justify-content: space-between;
                /* gap: 17rem; */
                padding: 0.5rem 2vw 0.5rem 1vw;
                min-width: -webkit-fill-available;
                min-height: 64px;
            }
            .brand-group {
                display: flex;
                align-items: center;
                gap: 1rem;
            }
            .logo {
                width: 64px;
                height: auto;
                margin: 0 0.5rem 0 0;
                filter: drop-shadow(0 0 8px #dbab10);
            }
            .header-text {
                display: flex;
                flex-direction: column;
                justify-content: center;
            }
            .header-text h1 {
                margin: 0;
                font-size: 1.6rem;
                color: #dbab10;
                font-weight: 900;
                text-shadow: 0 2px 12px #dbab1044;
            }
            .header-text .subtitle {
                color: #fff;
                font-size: 1rem;
                font-weight: 700;
                margin-top: 0.1rem;
            }
            .menu-bar {
                display: flex;
                gap: 1rem;
                margin-left: auto;
                background: none;
                border: none;
                padding: 0;
            }
            .menu-btn {
                background: none;
                border: none;
                color: #dbab10;
                font-size: 1rem;
                font-weight: 700;
                padding: 0.5rem 1.2rem;
                cursor: pointer;
                border-radius: 6px;
                transition: background 0.2s, color 0.2s;
            }
            .menu-btn.active, .menu-btn:hover {
                background: #dbab10;
                color: #111112;
            }
            .campaign-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
                gap: 1.5rem;
                margin-top: 1rem;
            }
            .planet-card {
                background: #222;
                border-radius: 10px;
                border: 2px solid #dbab10;
                box-shadow: 0 2px 12px #dbab1022;
                padding: 1rem 1.2rem;
                color: #fff;
                font-size: 0.98rem;
            }
            .planet-card.automatons {
                border-color: #fe6d72;
            }
            .planet-card.terminids {
                border-color: #ffc100;
            }
            .planet-card.illuminates {
                border-color: #6b3aba;
            }
            .planet-card .planet-header {
                font-size: 1.08rem;
                font-weight: bold;
                margin-bottom: 0.3rem;
            }
            .planet-card.automatons .planet-header {
                color: #fe6d72;
            }
            .planet-card.terminids .planet-header {
                color: #ffc100;
            }
            .planet-card.illuminates .planet-header {
                color: #6b3aba;
            }
            @media (max-width: 800px) {
                main {
                    margin: 0;
                    padding: 0.5rem;
                }
                .roster {
                    min-width: -webkit-fill-available;
                    gap: 1.2rem;
                }
                .modal {
                    min-width: 90vw;
                    padding: 1rem;
                }
            }
            @media (max-width: 900px) {
                @media (max-width: 500px) {
                    body, main, .about-section, .division-expander, .modal, .company-list, .planet-card {
                        font-size: 0.98rem !important;
                    }
                    h1, h2 {
                        font-size: 1.3rem !important;
                    }
                    .header-content {
                        flex-direction: column;
                        gap: 1.2rem;
                        padding: 0.5rem 2vw 0.5rem 1vw;
                    }
                    .brand-group {
                        flex-direction: column;
                        gap: 0.5rem;
                    }
                    .logo {
                        width: 48px;
                    }
                    .menu-modal {
                        min-width: 90vw;
                        max-width: 98vw;
                        padding: 1rem 0.5rem 1rem 0.5rem;
                    }
                    .menu-modal-btn {
                        font-size: 1.1rem;
                        padding: 0.5rem 1rem;
                    }
                }
                .roster {
                    grid-template-columns: 1fr;
                }
            }
        </style>
    </head>

    <body>
        <header>
            <div class="header-content">
                <a href="https://77th-ab.github.io/" style="text-decoration:none;outline:none;display:flex;align-items:center;gap:1rem;">
                    <img src="https://77th-ab.github.io/data/logo.png" alt="77th Assault Brigade Logo" class="logo" style="cursor:pointer;">
                    <div class="header-text" style="cursor:pointer;">
                        <h1 style="pointer-events:none;">77th Assault<br>Brigade</h1>
                    </div>
                </a>
                <button id="menu-modal-btn" class="menu-modal-btn" aria-label="Open menu">&#9776; Menu</button>
            </div>
        </header>
        <main>
            <div id="page-home" style="display:none;">
                <img src="https://77th-ab.github.io/data/orbit_sc_01.jpg" alt="Super Earth Home" class="hero-img">
                <div class="about-section" style="color:#fff;">
                    <h2 style="color:#dbab10;margin-top:0;">About the 77th Assault Brigade</h2>
                    <p>The 77th Assault Brigade is a Helldivers 2 community dedicated to coordinated gameplay, camaraderie, and galactic liberation. We operate as a structured brigade with multiple divisions, each specializing in different aspects of the war effort. Our mission: defend Super Earth and bring Managed Democracy to the galaxy!</p>
                </div>
                <div id="division-expanders"></div>
            </div>
            <div id="page-roster">
                <img src="https://77th-ab.github.io/data/orbit_sc_01.jpg" alt="Brigade Roster" class="hero-img" style="max-height:260px;object-fit:cover;">
                <section>
                    <h2 style="color:#dbab10;">Official Roster</h2>
                    <p style="margin-bottom: 2rem;">Below you will find the official roster of the 77th Assault Brigade, including all active Helldivers and their respective roles.</p>
                    <div id="roster" class="roster">
                        <!-- Dynamic content -->
                    </div>
                </section>
            </div>
            <div id="page-report" style="display:none;">
                <img src="https://77th-ab.github.io/data/orbit_sc_01.jpg" alt="War Report" class="hero-img" style="max-height:260px;object-fit:cover;">
                <div class="intro">
                    <h2 style="color:#dbab10;">War Room</h2>
                    <div id="war-report">
                        <!-- Deployment Recommendations will appear here -->
                    </div>
                    <br><hr>
                    <div id="active-planets">
                        <!-- Active Planets grid will appear here -->
                    </div>
                </div>
            </div>
            <div id="page-join" style="display:none;">
                <img src="https://77th-ab.github.io/data/ground_sc_01.jpg" alt="Join the Brigade" class="hero-img" style="max-height:260px;object-fit:cover;">
                <div class="about-section" style="margin-top:3rem;">
                    <h2 style="color:#dbab10;margin-top:0;">Join the 77th Assault Brigade</h2>
                    <p style="color: #fff;">Welcome, Helldiver! The 77th Assault Brigade is a friendly, organized community for Helldivers 2 players who value teamwork, respect, and fun. Before joining, please review our rules and instructions below.</p>
                    <h3 style="color:#dbab10;">Community Rules</h3>
                    <p style="color:#fff;font-size:1.08rem;line-height:1.7;max-width:700px;margin:0 auto 1.2rem auto;">The following rules are set out as a guideline for all members, however full rules can be found on our Discord server during registration:</p>
                    <ul style="color:#fff;font-size:1.08rem;line-height:1.7;max-width:700px;margin:0 auto 1.2rem auto;">
                        <li><b>Respect all members</b> – No harassment, hate speech, slurs or discrimination will be tolerated.</li>
                        <li><b>Play cooperatively</b> – Work as a team, follow squad/command structure, and help new players.</li>
                        <li><b>No cheating or exploits</b> – Play fair and uphold the spirit of the game.</li>
                        <li><b>Keep chat friendly</b> – No spamming, advertising, or NSFW content.</li>
                        <li><b>Follow leadership instructions</b> – Respect division/company/squad leaders during operations.</li>
                        <li><b>Have fun!</b> – We're here to enjoy Helldivers 2 together.</li>
                    </ul>
                    <h3 style="color:#dbab10;">How to Join</h3>
                    <ol style="color:#fff;font-size:1.08rem;line-height:1.7;max-width:700px;margin:0 auto 1.2rem auto;">
                        <li>Join our Discord server: <a href="https://discord.gg/cer57Wdcr7" target="_blank" style="color:#dbab10;text-decoration:underline;">discord.gg/cer57Wdcr7</a></li>
                        <li>Read the <b>rules</b> and follow the on-screen instructions to agree.</li>
                        <li>Introduce yourself in the #barracks channel.</li>
                        <li>Read the pinned messages in the #welcome channel.</li>
                        <li>Check the <b>roster</b> page for division/company info and request placement if desired.</li>
                        <li>Start diving! Participate in games, events, and campaigns.</li>
                    </ol>
                    <div style="margin-top:1.2rem;color:#dbab10;font-size:1.05rem;">Questions? Contact a Democracy Officer on Discord.</div>
                </div>
            </div>
            <footer style="width:-webkit-fill-available;background:#18181a;border-top:3px solid #dbab10;padding:1.2rem 0 1.2rem 0;text-align:center;color:#dbab10;font-size:1rem;letter-spacing:1px;box-shadow:0 -2px 12px #000a;margin-top:3rem;">
                &copy; 2025 77th Assault Brigade &mdash; Helldivers 2 Community.<br><small style="color: #aaa;"><i>Not affiliated with Arrowhead Game Studios or Sony Interactive Entertainment. For community use only.</i></small>
            </footer>
        </main>
        
        <div id="modal-bg" class="modal-bg"></div>
        <script>
            // Modal menu logic
            function showMenuModal() {
                let menuModalBg = document.getElementById('menu-modal-bg');
                if (!menuModalBg) {
                    menuModalBg = document.createElement('div');
                    menuModalBg.id = 'menu-modal-bg';
                    menuModalBg.className = 'menu-modal-bg';
                    document.body.appendChild(menuModalBg);
                }
                menuModalBg.innerHTML = `<div class="menu-modal">
                    <button class="menu-modal-close" aria-label="Close">&times;</button>
                    <h2 style='color:#dbab10;'>Menu</h2>
                    <div style='margin:1.2rem 0;'>
                        <button class='menu-btn' id='menu-home'>Home</button><br><br>
                        <button class='menu-btn' id='menu-roster'>Official Roster</button><br><br>
                        <button class='menu-btn' id='menu-report'>War Room</button><br><br>
                        <!-- Major Orders button removed -->
                        <button class='menu-btn' id='menu-join'>Joining Up</button>
                    </div>
                </div>`;
                // Add event listeners to close modal on menu selection
                menuModalBg.querySelector('#menu-home').onclick = function() {
                    window.location.hash = '#home';
                    closeMenuModal();
                };
                menuModalBg.querySelector('#menu-roster').onclick = function() {
                    window.location.hash = '#roster';
                    closeMenuModal();
                };
                menuModalBg.querySelector('#menu-report').onclick = function() {
                    window.location.hash = '#report';
                    closeMenuModal();
                };
                menuModalBg.querySelector('#menu-join').onclick = function() {
                    window.location.hash = '#join';
                    closeMenuModal();
                };
                menuModalBg.style.display = 'block';
                setTimeout(() => { menuModalBg.style.opacity = 1; }, 10);
                menuModalBg.querySelector('.menu-modal-close').onclick = closeMenuModal;
                menuModalBg.onclick = function (e) {
                    if (e.target === menuModalBg) closeMenuModal();
                };
            }
            function closeMenuModal() {
                const menuModalBg = document.getElementById('menu-modal-bg');
                if (menuModalBg) {
                    menuModalBg.style.opacity = 0;
                    setTimeout(() => {
                        menuModalBg.style.display = 'none';
                        menuModalBg.innerHTML = '';
                    }, 200);
                }
            }
            document.getElementById('menu-modal-btn').onclick = showMenuModal;
            // Super Earth SPA JS
            let rosterData = [];

            // Ensures rosterData is loaded and cached globally
            function ensureRosterData() {
                if (window.rosterData && Array.isArray(window.rosterData) && window.rosterData.length > 0) {
                    return Promise.resolve(window.rosterData);
                }
                return fetch('https://77th-ab.github.io/data/roster.json')
                    .then(res => {
                        if (!res.ok) throw new Error('Failed to fetch roster data');
                        return res.json();
                    })
                    .then(data => {
                        window.rosterData = data;
                        return data;
                    })
                    .catch(e => {
                        window.rosterData = [];
                        return [];
                    });
            }

            // Returns companies for a given division tag from the roster
            function getDivisionCompanies(divisionTag, roster) {
                if (!Array.isArray(roster)) return [];
                const division = roster.find(div => div.tag === divisionTag);
                return division && Array.isArray(division.companies) ? division.companies : [];
            }

            // Counts non-vacant members in a company object
            function countNonVacantMembers(company) {
                if (!company || !Array.isArray(company.squads)) return 0;
                let count = 0;
                company.squads.forEach(squad => {
                    if (Array.isArray(squad.members)) {
                        squad.members.forEach(member => {
                            if (member[0] && member[0].toLowerCase() !== 'vacant') {
                                count++;
                            }
                        });
                    }
                });
                return count;
            }

            // Returns a CSS class name for a given faction string
            function getFactionClass(faction) {
                if (!faction) return '';
                const f = faction.toLowerCase();
                if (f.includes('automatons')) return 'automatons';
                if (f.includes('terminids')) return 'terminids';
                if (f.includes('illuminates')) return 'illuminates';
                return '';
            }

            async function fetchRoster() {
                const url = 'https://77th-ab.github.io/data/roster.json';
                try {
                    const res = await fetch(url);
                    if (!res.ok) throw new Error('Failed to fetch roster data');
                    return await res.json();
                } catch (e) {
                    document.getElementById('roster').innerHTML = `<div style='color:red;'>Error loading roster data.</div>`;
                    return null;
                }
            }

            function createDivisionCard(division, idx) {
                return `
        <div class="division-card" data-idx="${idx}" tabindex="0" aria-label="${division.name} (${division.tag})">
            <div class="division-title">${division.name} <span style="font-size:0.9rem;color:#aaa;">(${division.tag})</span></div>
            <div class="division-commander">Division Commander: ${division.commander[0]} (${division.commander[1]})</div>
            <div class="division-deployment">Deployment: <b>${division.deployment.focus}</b></div>
        </div>
        `;
            }

            function createDivisionModal(division) {
                return `
        <button class="modal-close" aria-label="Close">&times;</button>
        <h2>${division.name} <span style="font-size:0.9rem;color:#aaa;">(${division.tag})</span></h2>
        <div class="commander">Division Commander: ${
            division.commander[0].toLowerCase() === 'vacant'
                ? `<a href=\"#join\" class=\"vacant-link\" title=\"Join Up\" onclick=\"closeModal()\">Vacant</a>`
                : division.commander[0]
        } (${division.commander[1]})</div>
        <div class="deployment">Deployment: <b>${division.deployment.focus}</b></div>
        <hr style="border:1px solid #dbab10; margin:1rem 0;">
        <div class="company-list">
            ${division.companies.map(company => `
                <div class="company">
                    <h3>${company.name} <span style="font-size:0.9rem;color:#aaa;">(${company.tag})</span></h3>
                    <div class="commander">CO: ${
                        company.commander[0].toLowerCase() === 'vacant'
                            ? `<a href=\"#join\" class=\"vacant-link\" title=\"Join Up\" onclick=\"closeModal()\">Vacant</a>`
                            : company.commander[0]
                    } (${company.commander[1]})</div>
                    ${company.squads.map(squad => `
                        <div class="squad">
                            <div class="squad-name">${squad.name}</div>
                            <ul class="members">
                                ${squad.members.map(member => {
                                    if (member[0].toLowerCase() === 'vacant') {
                                        return `<li><a href="#join" class="vacant-link" title="Join Up" onclick="closeModal()">Vacant</a> (${member[1]})</li>`;
                                    } else {
                                        return `<li>${member[0]} (${member[1]})</li>`;
                                    }
                                }).join('')}
                            </ul>
                        </div>
                    `).join('')}
                </div>
            `).join('')}
        </div>
        `;
            }

            function showModal(division) {
                const modalBg = document.getElementById('modal-bg');
                modalBg.innerHTML = `<div class="modal">${createDivisionModal(division)}</div>`;
                modalBg.style.display = 'block';
                setTimeout(() => { modalBg.style.opacity = 1; }, 10);
                // Close button
                modalBg.querySelector('.modal-close').onclick = closeModal;
                // ESC key
                document.addEventListener('keydown', escListener);
                // Click outside modal
                modalBg.onclick = function (e) {
                    if (e.target === modalBg) closeModal();
                };
            }

            function closeModal() {
                const modalBg = document.getElementById('modal-bg');
                modalBg.style.opacity = 0;
                setTimeout(() => {
                    modalBg.style.display = 'none';
                    modalBg.innerHTML = '';
                }, 200);
                document.removeEventListener('keydown', escListener);
            }

            function escListener(e) {
                if (e.key === 'Escape') closeModal();
            }

            async function renderRoster() {
                const data = await fetchRoster();
                if (!data) return;
                rosterData = data;
                const rosterDiv = document.getElementById('roster');
                rosterDiv.innerHTML = data.map((div, idx) => createDivisionCard(div, idx)).join('');
                // Add click listeners
                Array.from(document.getElementsByClassName('division-card')).forEach(card => {
                    card.onclick = function () {
                        const idx = this.getAttribute('data-idx');
                        showModal(rosterData[idx]);
                    };
                    card.onkeydown = function (e) {
                        if (e.key === 'Enter' || e.key === ' ') {
                            const idx = this.getAttribute('data-idx');
                            showModal(rosterData[idx]);
                        }
                    };
                });
            }

            // ...existing code...
// Home page: Division expanders
function renderDivisionExpanders() {
    const container = document.getElementById('division-expanders');
    if (!window.rosterData || !Array.isArray(window.rosterData)) {
        container.innerHTML = '<div style="color:#dbab10;">Loading division info...</div>';
        return;
    }
    container.innerHTML = window.rosterData.map((div, idx) => `
        <div class="division-expander" tabindex="0" data-idx="${idx}">
            <div class="expander-title">
                ${div.patch_logo ? `<img src="${div.patch_logo}" alt="${div.name} Patch" style="height:100px;width:auto;vertical-align:middle;margin-right:0.7rem;border-radius:6px;border:2px solid #dbab10;box-shadow:0 2px 8px #dbab1044;">` : ''}
                <div style="margin-top: 3px;">
                    ${div.name} <span style="font-size:0.9rem;color:#aaa;"> (${div.tag})</span><br>
                    <span style="font-size:0.95rem;color:#aaa;"><br>Deployment Focus<br><span style="color:#fff; font-weight:normal;font-style:italic;">${div.deployment.focus ? div.deployment.focus : 'Not specified'}</span></span>
                </div>
            </div>
            <div class="expander-content" style="color: #ffffff;">${div.about ? div.about : 'No description available.'}</div>
        </div>
    `).join('');
    Array.from(document.getElementsByClassName('division-expander')).forEach(expander => {
        expander.onclick = function () {
            this.classList.toggle('active');
        };
        expander.onkeydown = function (e) {
            if (e.key === 'Enter' || e.key === ' ') {
                this.classList.toggle('active');
            }
        };
    });
}

// War Report: Cross-reference planets for recommendations
async function fetchWarReportWithPlanets() {
    const reportDiv = document.getElementById('war-report');
    const planetsDiv = document.getElementById('active-planets');
    // Only show loading if first load or error
    if (!window._lastWarReportRelevant) {
        reportDiv.innerHTML = '<div style="color:#dbab10;">Analyzing battlefronts...</div>';
        planetsDiv.innerHTML = '';
    }
    try {
        // Fetch campaign data
        const res = await fetch('https://helldiverstrainingmanual.com/api/v1/war/campaign');
        if (!res.ok) throw new Error('Failed to fetch campaign data');
        const planetsRaw = await res.json();
        const planets = Object.values(planetsRaw);
            // Only update if relevant planet fields have changed
            function getRelevantPlanetFields(planetsArr) {
                return (planetsArr || []).map(p => ({
                    name: p.name,
                    health: p.health,
                    maxHealth: p.maxHealth,
                    defense: p.defense,
                    faction: p.faction,
                    biome: p.biome ? p.biome.description : ''
                }));
            }
            const newRelevant = getRelevantPlanetFields(planets);
            const lastRelevant = window._lastWarReportRelevant || [];
            let changed = false;
            if (newRelevant.length !== lastRelevant.length) {
                changed = true;
            } else {
                for (let i = 0; i < newRelevant.length; i++) {
                    const a = newRelevant[i], b = lastRelevant[i];
                    if (!b || a.name !== b.name || a.health !== b.health || a.maxHealth !== b.maxHealth || a.defense !== b.defense || a.faction !== b.faction || a.biome !== b.biome) {
                        changed = true;
                        break;
                    }
                }
            }
            if (changed) {
                window._lastWarReportRelevant = newRelevant;
                // Group by faction
                const fronts = {
                    Automatons: [],
                    Terminids: [],
                    Illuminates: []
                };
                planets.forEach(p => {
                    const faction = p.faction ? p.faction.toLowerCase() : '';
                    if (faction.includes('automatons')) fronts.Automatons.push(p);
                    else if (faction.includes('terminids')) fronts.Terminids.push(p);
                    else if (faction.includes('illuminates')) fronts.Illuminates.push(p);
                });
                // Recommend 2 planets per front (lowest health %)
                function recommend(frontArr) {
                    return frontArr
                        .filter(p => typeof p.health === 'number' && typeof p.maxHealth === 'number')
                        .map(p => ({
                            ...p,
                            percentage: p.maxHealth > 0 ? (p.health / p.maxHealth) * 100 : 0,
                            completion: p.maxHealth > 0 ? (100 - ((p.health / p.maxHealth) * 100)) : 0
                        }))
                        // Sort by planetIndex ascending, then by completion percentage descending
                        .sort((a, b) => {
                            if (a.planetIndex !== undefined && b.planetIndex !== undefined) {
                                if (a.planetIndex !== b.planetIndex) {
                                    return a.planetIndex - b.planetIndex;
                                }
                            }
                            return b.completion - a.completion;
                        })
                        .slice(0, 2);
                }
                const recs = {
                    Automatons: recommend(fronts.Automatons),
                    Terminids: recommend(fronts.Terminids),
                    Illuminates: recommend(fronts.Illuminates),
                };
                // Get companies from rosterData (global)
                const roster = await ensureRosterData();
                const companies = {
                    Automatons: getDivisionCompanies('1ST', roster),
                    Terminids: getDivisionCompanies('2ND', roster),
                    Illuminates: getDivisionCompanies('3RD', roster),
                };
                function assignCompaniesToPlanets(companiesArr, planetsArr) {
                    // Sort companies by non-vacant members desc, then alphabetically
                    let sorted = (companiesArr || []).slice().sort((a, b) => {
                        const aCount = countNonVacantMembers(a);
                        const bCount = countNonVacantMembers(b);
                        if (aCount === 0 && bCount === 0) {
                            return a.name.localeCompare(b.name);
                        }
                        return bCount - aCount || a.name.localeCompare(b.name);
                    });
                    // Assign companies to planets
                    return planetsArr.map((planet, i) => {
                        const company = sorted[i % sorted.length];
                        return { planet, company };
                    });
                }
                const assignments = {
                    Automatons: assignCompaniesToPlanets(companies.Automatons, recs.Automatons),
                    Terminids: assignCompaniesToPlanets(companies.Terminids, recs.Terminids),
                    Illuminates: assignCompaniesToPlanets(companies.Illuminates, recs.Illuminates),
                };
                // --- Granular DOM update ---
                // War Report Section
                let reportHtml = `<div style='font-size:1.1rem;margin-bottom:2rem;'>AI Deployment Recommendations</div><div class='campaign-grid'>`;
                ['Automatons','Terminids','Illuminates'].forEach(faction => {
                    reportHtml += `<div class='planet-card ${faction.toLowerCase()}'>`;
                    reportHtml += `<div class='planet-header'>${faction} Front</div><div style='margin-bottom:0.5rem;'>Recommended Planets & Companies:</div>`;
                    assignments[faction].forEach(({planet, company}) => {
                        const cardId = `report-${faction}-${planet.name.replace(/\s+/g,'_')}`;
                        let existing = document.getElementById(cardId);
                        let cardHtml = `<div id='${cardId}' style='margin-top:2rem;'>`;
                        cardHtml += `<hr style='border-top: 1px solid #eee;'>`;
                        cardHtml += `<br><b>${planet.name}</b><br><span style='color:#dbab10;'>(Completion: ${planet.completion.toFixed(1)}%)</span>`;
                        // Progress bar
                        let barColor = '#fe6d72'; // red for low
                        if (planet.completion >= 75) barColor = '#00db4a'; // green
                        else if (planet.completion >= 25) barColor = '#ffc100'; // yellow
                        else if (planet.completion < 25) barColor = '#fe6d72'; // red
                        cardHtml += `<div style='width:100%;height:18px;background:#313131;border-radius:8px;margin:8px 0 8px 0;box-shadow:0 2px 8px #0002;'><div style='height:100%;width:${planet.completion}%;background:${barColor};border-radius:8px;transition:width 0.5s;'></div></div>`;
                        cardHtml += `<b>Health:</b> <i style="color:#aaa;">${planet.health.toLocaleString()}</i> / <i style="color:#aaa;">${planet.maxHealth.toLocaleString()}</i><br>`;
                        cardHtml += `<b>Biome:</b> ${planet.biome ? planet.biome.description : 'Unknown'}<br><br>`;
                        cardHtml += `<span style='color:${faction==='Automatons'?'#00bfff':faction==='Terminids'?'#ff9800':'#b366ff'};'>Recommended Company:<br><span style='color:#aaa;'>${company ? company.name : 'N/A'}</span></span>`;
                        cardHtml += `</div>`;
                        reportHtml += cardHtml;
                    });
                    reportHtml += `</div>`;
                });
                reportHtml += `</div><div style='margin-top:2rem;font-size:0.98rem;color:#dbab10;'><b>Advisory:</b><br><span style="color: #ffffff;">Planet recommendations are selected by prioritizing those closest to Super Earth (lowest planetIndex) and, in case of ties, by highest completion percentage.<br><br>Company assignments are based on current complement (non-vacant members), with alphabetical fallback. These recommendations are advisory only; actual deployments may vary based on strategic needs and real-time developments.</span></div>`;
                reportDiv.innerHTML = reportHtml;
                // Active Planets Section
                let sortedPlanets = planets.filter(p => typeof p.planetIndex === 'number').sort((a, b) => a.planetIndex - b.planetIndex);
                let activeHtml = `<div style='font-size:1.1rem;margin-bottom:2rem;margin-top:2rem;'>Top 12 Active Planets</div><div class='campaign-grid'>`;
                sortedPlanets.slice(0,12).forEach(p => {
                    const factionClass = getFactionClass(p.faction);
                    const cardId = `active-${p.name.replace(/\s+/g,'_')}`;
                    let cardHtml = `<div id='${cardId}' class='planet-card ${factionClass}'>`;
                    cardHtml += `<div class='planet-header'>${p.name}</div>`;
                    cardHtml += `Faction: <span>${p.faction}</span><br>`;
                    cardHtml += `Health: ${p.health.toLocaleString()} / ${p.maxHealth.toLocaleString()} (${p.percentage ? p.percentage.toFixed(1) : 0}%)<br>`;
                    cardHtml += `Defense: ${p.defense ? 'Yes' : 'No'}<br><br>`;
                    cardHtml += `Biome: ${p.biome ? p.biome.description : 'Unknown'}`;
                    cardHtml += `</div>`;
                    activeHtml += cardHtml;
                });
                activeHtml += `</div>`;
                planetsDiv.innerHTML = activeHtml;
            }
    } catch (e) {
        reportDiv.innerHTML = `<div style='color:red;'>Error loading war report data:<br>${e.message}</div>`;
        planetsDiv.innerHTML = '';
    }
}
            // Make these functions global
            const pageHome = document.getElementById('page-home');
            const pageRoster = document.getElementById('page-roster');
            // const pageCampaign = document.getElementById('page-campaign'); // removed
            const pageReport = document.getElementById('page-report');
            const pageJoin = document.getElementById('page-join');
            // Major Orders page removed

            function showPage(page) {
                pageHome.style.display = 'none';
                pageRoster.style.display = 'none';
                // pageCampaign.style.display = 'none'; // removed
                pageReport.style.display = 'none';
                pageJoin.style.display = 'none';
                // pageMajorOrders.style.display = 'none';
                if (page === 'home') {
                    pageHome.style.display = '';
                    if (!window.rosterData || !Array.isArray(window.rosterData) || window.rosterData.length === 0) {
                        // Try to load rosterData if not present
                        ensureRosterData().then(() => {
                            renderDivisionExpanders();
                        });
                    } else {
                        renderDivisionExpanders();
                    }
                } else if (page === 'roster') {
                    pageRoster.style.display = '';
                } else if (page === 'report') {
                    pageReport.style.display = '';
                    fetchWarReportWithPlanets();
                // else if (page === 'majororders') { /* removed */ }
                } else if (page === 'join') {
                    pageJoin.style.display = '';
                } else {
                    pageHome.style.display = '';
                    renderDivisionExpanders();
                }
            }

            function handleHash() {
                const hash = window.location.hash.replace('#', '').toLowerCase();
                if (hash === 'roster') {
                    showPage('roster');
                } else if (hash === 'report') {
                    showPage('report');
                // else if (hash === 'majororders') { /* removed */ }
                } else if (hash === 'join') {
                    showPage('join');
                } else {
                    showPage('home');
                }
            }
            window.addEventListener('hashchange', handleHash);
            handleHash();

            renderRoster();

            // Auto-refresh all API-driven sections every 5 seconds
            setInterval(() => {
                // Roster (if visible)
                if (document.getElementById('page-roster').style.display !== 'none') {
                    renderRoster();
                }
                // War Room (if visible)
                if (document.getElementById('page-report').style.display !== 'none') {
                    fetchWarReportWithPlanets();
                }
                // Home page division expanders (if visible)
                if (document.getElementById('page-home').style.display !== 'none') {
                    ensureRosterData().then(() => {
                        renderDivisionExpanders();
                    });
                }
            }, 5000);
        </script>
    </body>

</html>
